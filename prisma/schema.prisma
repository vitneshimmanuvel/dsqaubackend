// This is your Prisma schema file for D Square CRM
// Using Neon PostgreSQL database

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model - Enhanced for role hierarchy
model User {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  password    String
  role        UserRole @default(CUSTOMER)
  phone       String?
  avatar      String?
  address     String?
  isActive    Boolean  @default(true)
  permissions String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // For customers - which admin manages them
  assignedToId String?
  assignedTo   User?   @relation("AdminCustomers", fields: [assignedToId], references: [id])
  customers    User[]  @relation("AdminCustomers")

  // Projects where this user is the client
  clientProjects    Project[] @relation("ProjectClient")
  // Projects assigned to admin
  assignedProjects  Project[] @relation("ProjectAdmin")
  // Projects created by this user
  createdProjects   Project[] @relation("ProjectCreator")
  
  notifications     Notification[]
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CUSTOMER
}

// Project Model - Enhanced with stages
model Project {
  id          String        @id @default(cuid())
  name        String
  clientName  String
  clientPhone String?
  clientAddress String?
  location    String?
  status      ProjectStatus @default(PLANNING)
  progress    Int           @default(0)
  startDate   DateTime
  deadline    DateTime
  budget      Float         @default(0)
  spent       Float         @default(0)
  thumbnail   String        @default("https://images.unsplash.com/photo-1600596542815-2ad4d9a44566?auto=format&fit=crop&w=600&q=80")
  description String?
  notes       String?
  gallery     String[]
  
  // Project stages as JSON
  stages      Json?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  clientId       String?
  client         User?          @relation("ProjectClient", fields: [clientId], references: [id])
  assignedAdminId String?
  assignedAdmin  User?          @relation("ProjectAdmin", fields: [assignedAdminId], references: [id])
  createdById    String?
  createdBy      User?          @relation("ProjectCreator", fields: [createdById], references: [id])
  
  milestones     Milestone[]
  documents      Document[]
  invoices       Invoice[]
  budgetItems    BudgetItem[]
  materials      Material[]
  workerLogs     WorkerLog[]
  transactions   Transaction[]
  notifications  Notification[]
  payments       Payment[]
}

enum ProjectStatus {
  PLANNING
  FOUNDATION
  STRUCTURE
  FINISHING
  COMPLETED
  ON_HOLD
}

// Payment Milestone Model - Track payment stages with Two-Sided Acknowledgment
model Payment {
  id          String        @id @default(cuid())
  stageName   String        // "Advance", "Foundation Complete", "Structure Complete", "Final"
  amount      Float         // Total amount for this stage
  paidAmount  Float         @default(0)  // Amount paid so far (for part payments)
  dueDate     DateTime?
  paidDate    DateTime?
  status      PaymentMilestoneStatus @default(PENDING)
  
  // Two-Sided Acknowledgment
  adminAcknowledged     Boolean   @default(false)  // Admin confirms payment request
  adminAcknowledgedAt   DateTime?
  adminAcknowledgedBy   String?   // Admin user ID
  clientAcknowledged    Boolean   @default(false)  // Client confirms receipt/acceptance
  clientAcknowledgedAt  DateTime?
  clientNotes           String?   // Client can add notes when acknowledging
  
  // Reminders
  reminderEnabled       Boolean   @default(true)
  reminderDays          Int       @default(3)  // Days before due date to remind
  lastReminderSent      DateTime?
  
  // Part Payment Tracking
  isPartPayment         Boolean   @default(false)
  partPayments          PartPayment[]
  
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// Part Payment Records
model PartPayment {
  id          String   @id @default(cuid())
  amount      Float
  paidDate    DateTime @default(now())
  notes       String?
  receiptUrl  String?  // Upload payment receipt
  
  // Acknowledgment
  adminAcknowledged   Boolean   @default(false)
  clientAcknowledged  Boolean   @default(false)
  
  paymentId   String
  payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

enum PaymentMilestoneStatus {
  PENDING           // Not yet due
  AWAITING_CLIENT   // Admin requested, waiting for client acknowledgment
  AWAITING_ADMIN    // Client paid, waiting for admin confirmation
  PARTIAL           // Part payment received
  PAID              // Fully paid and acknowledged
  OVERDUE           // Past due date
}

// Milestone Model
model Milestone {
  id          String          @id @default(cuid())
  title       String
  date        DateTime
  status      MilestoneStatus @default(PENDING)
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum MilestoneStatus {
  COMPLETED
  IN_PROGRESS
  PENDING
}

// Document Model
model Document {
  id         String       @id @default(cuid())
  name       String
  type       DocumentType @default(PDF)
  category   String?      // "contract", "drawing", "invoice", "permit", "other"
  url        String
  publicId   String?
  size       String?
  uploadedAt DateTime     @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum DocumentType {
  PDF
  DWG
  IMG
  XLS
  DOC
}

// Invoice Model
model Invoice {
  id        String        @id @default(cuid())
  number    String
  amount    Float
  date      DateTime      @default(now())
  status    InvoiceStatus @default(PENDING)
  stage     String?
  createdAt DateTime      @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum InvoiceStatus {
  PAID
  PENDING
  OVERDUE
}

// Budget Item Model
model BudgetItem {
  id          String         @id @default(cuid())
  category    BudgetCategory
  description String?
  amount      Float

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum BudgetCategory {
  MATERIALS
  LABOR
  EQUIPMENT
  OVERHEAD
}

// Vendor Model - Enhanced with payment history
model Vendor {
  id            String          @id @default(cuid())
  name          String
  contactPerson String
  phone         String
  email         String?
  address       String?
  gstNumber     String?
  panNumber     String?
  bankName      String?
  bankAccount   String?
  ifscCode      String?
  rating        Float           @default(3)
  specialty     String          @default("GENERAL")  // Flexible specialty
  location      String
  isActive      Boolean         @default(true)
  notes         String?
  
  // Payment summary
  totalOrders     Int           @default(0)
  totalAmount     Float         @default(0)
  totalPaid       Float         @default(0)
  pendingAmount   Float         @default(0)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  materials     Material[]
  payments      MaterialPayment[]
}

// Material Order Model - Enhanced with payment tracking
model Material {
  id              String         @id @default(cuid())
  item            String
  description     String?
  materialType    String?        // Cement, Sand, Bricks, Steel, etc.
  supplier        String
  quantity        Int
  unit            String         @default("PIECES")  // Flexible unit
  unitPrice       Float          @default(0)
  totalCost       Float          // quantity * unitPrice
  
  // Order tracking
  status          MaterialStatus @default(PENDING)
  orderDate       DateTime       @default(now())
  expectedDelivery DateTime?
  deliveredDate   DateTime?
  receivedQuantity Int?          // Actual quantity received (may differ)
  qualityCheck    Boolean        @default(false)
  qualityNotes    String?
  
  // Payment tracking
  paymentStatus   MaterialPaymentStatus @default(PENDING)
  paidAmount      Float          @default(0)
  remainingAmount Float          @default(0)
  payments        MaterialPayment[]
  
  // Reminders
  paymentDueDate  DateTime?
  reminderEnabled Boolean        @default(true)
  reminderDays    Int            @default(3)
  lastReminderSent DateTime?
  
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id])
  vendorId   String?
  vendor     Vendor?  @relation(fields: [vendorId], references: [id])
}

// Material Payment - Track individual payments to vendors
model MaterialPayment {
  id          String   @id @default(cuid())
  amount      Float
  paymentDate DateTime @default(now())
  paymentMode String?  // CASH, BANK, UPI, CHEQUE
  reference   String?  // Transaction ID, cheque number, etc.
  notes       String?
  receiptUrl  String?
  
  materialId  String
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  vendorId    String?
  vendor      Vendor?  @relation(fields: [vendorId], references: [id])
  
  createdAt   DateTime @default(now())
}

enum MaterialStatus {
  PENDING
  ORDERED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum MaterialPaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

// Worker Log Model - Enhanced with individual tracking, mistakes, acknowledgment
model WorkerLog {
  id            String         @id @default(cuid())
  category      String         // Can be predefined or custom category
  customCategory String?       // For user-defined categories
  workerName    String?        // Optional worker name for individual tracking
  workerRole    String?        // Role/designation
  count         Int            @default(1)
  shift         Shift          @default(DAY)
  shiftFraction Float          @default(1.0)  // 1.0 = full shift, 0.5 = half shift
  date          DateTime       @default(now())
  hoursWorked   Int            @default(8)
  ratePerWorker Float
  totalWage     Float          // Auto-calculated
  status        WorkerPaymentStatus  @default(PENDING)
  
  // Acknowledgment for work verification
  workVerified      Boolean    @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?    // Admin who verified
  
  // Mistake/Issue tracking
  hasMistake        Boolean    @default(false)
  mistakeDescription String?
  mistakeAcknowledged Boolean  @default(false)
  mistakeAcknowledgedAt DateTime?
  faultTolerance    String?    // LOW, MEDIUM, HIGH
  
  // Weekly payment tracking
  weekNumber        Int?       // ISO week number
  weekYear          Int?       // Year for the week
  weekPaymentId     String?    // Link to weekly payment batch
  
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
}

// Custom Worker Category - User can define their own
model CustomWorkerCategory {
  id          String   @id @default(cuid())
  name        String
  defaultRate Float    @default(500)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Weekly Payment Batch - For batch processing weekly wages
model WeeklyPaymentBatch {
  id          String   @id @default(cuid())
  weekNumber  Int
  weekYear    Int
  startDate   DateTime
  endDate     DateTime
  totalAmount Float    @default(0)
  workerCount Int      @default(0)
  status      WeeklyPaymentStatus @default(PENDING)
  paidAt      DateTime?
  notes       String?
  projectId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Shift {
  DAY
  NIGHT
  FULL_DAY
  HALF_DAY
}

enum WorkerPaymentStatus {
  PENDING
  APPROVED
  PAID
}

enum WeeklyPaymentStatus {
  PENDING
  PROCESSING
  PAID
}

// Transaction Model
model Transaction {
  id          String            @id @default(cuid())
  description String
  amount      Float
  type        TransactionType
  date        DateTime          @default(now())
  status      TransactionStatus @default(PENDING)
  category    TransactionCategory @default(OTHER)
  reference   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionStatus {
  PENDING
  COMPLETED
}

enum TransactionCategory {
  PAYMENT
  MATERIAL
  WAGES
  EQUIPMENT
  OVERHEAD
  OTHER
}

// Notification Model
model Notification {
  id        String           @id @default(cuid())
  title     String
  message   String
  type      NotificationType @default(INFO)
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
}

enum NotificationType {
  ALERT
  INFO
  SUCCESS
  WARNING
  PAYMENT_REMINDER
  PROJECT_UPDATE
}

// Lead Pipeline Model - For tracking potential clients
model Lead {
  id              String      @id @default(cuid())
  name            String
  phone           String
  email           String?
  address         String?
  source          LeadSource  @default(WEBSITE)
  interest        String?     // What they're interested in
  budget          Float?
  
  // Pipeline stage tracking
  stage           LeadStage   @default(NEW)
  stageHistory    String?     // JSON array of stage changes
  priority        LeadPriority @default(MEDIUM)
  temperature     String?     // HOT, WARM, COLD
  
  // Assignment
  assignedToId    String?
  
  // Follow-up tracking
  lastContactDate DateTime?
  nextFollowUp    DateTime?
  followUpCount   Int         @default(0)
  
  // Conversion
  isConverted     Boolean     @default(false)
  convertedToProjectId String?
  convertedAt     DateTime?
  lostReason      String?
  
  notes           String?
  tags            String[]    @default([])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  followUps       FollowUp[]
}

// Follow-up Model for tracking interactions
model FollowUp {
  id          String       @id @default(cuid())
  type        FollowUpType
  notes       String?
  outcome     String?      // What happened
  nextAction  String?      // What to do next
  scheduledAt DateTime?
  completedAt DateTime?
  isCompleted Boolean      @default(false)
  
  leadId      String
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdById String?
  createdAt   DateTime     @default(now())
}

enum LeadSource {
  WEBSITE
  REFERRAL
  ADVERTISEMENT
  SOCIAL_MEDIA
  WALK_IN
  PHONE_CALL
  OTHER
}

enum LeadStage {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  WON
  LOST
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum FollowUpType {
  CALL
  MEETING
  EMAIL
  SITE_VISIT
  PROPOSAL
  OTHER
}

// ========== RAW MATERIAL BUSINESS MODULE ==========

// Enquiry Model - Customer inquiries for raw materials
model Enquiry {
  id              String        @id @default(cuid())
  enquiryNumber   String        @unique @default(cuid())
  customerName    String
  customerPhone   String
  customerEmail   String?
  customerAddress String?
  
  // Enquiry details
  materialType    String        // Sand, Cement, Bricks, Steel, etc.
  quantity        Float
  unit            String        @default("TRUCKS")
  description     String?
  deliveryAddress String?
  deliveryDate    DateTime?
  
  // Pricing
  quotedPrice     Float?
  finalPrice      Float?
  isNegotiated    Boolean       @default(false)
  
  // Status tracking
  status          EnquiryStatus @default(NEW)
  priority        String?       @default("NORMAL")
  
  // Conversion
  convertedToOrderId String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  orders          RawMaterialOrder[]
}

// Raw Material Order - Orders placed for materials
model RawMaterialOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique @default(cuid())
  
  // Customer info
  customerName    String
  customerPhone   String
  customerAddress String?
  
  // Order details
  materialType    String
  quantity        Float
  unit            String              @default("TRUCKS")
  unitPrice       Float
  totalAmount     Float
  
  // Delivery
  deliveryAddress String
  deliveryDate    DateTime?
  deliveredDate   DateTime?
  vehicleNumber   String?
  driverName      String?
  driverPhone     String?
  
  // Status & Payment
  status          RawOrderStatus      @default(PENDING)
  paymentStatus   RawPaymentStatus    @default(UNPAID)
  paidAmount      Float               @default(0)
  paymentMode     String?
  
  // Tracking
  dispatchedAt    DateTime?
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  enquiryId       String?
  enquiry         Enquiry?            @relation(fields: [enquiryId], references: [id])
  
  payments        RawMaterialPayment[]
}

// Payment tracking for raw material orders
model RawMaterialPayment {
  id          String   @id @default(cuid())
  amount      Float
  paymentDate DateTime @default(now())
  paymentMode String?  // CASH, BANK, UPI, CHEQUE
  reference   String?
  notes       String?
  
  orderId     String
  order       RawMaterialOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

enum EnquiryStatus {
  NEW
  QUOTED
  NEGOTIATING
  CONFIRMED
  CANCELLED
  CONVERTED
}

enum RawOrderStatus {
  PENDING
  CONFIRMED
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum RawPaymentStatus {
  UNPAID
  PARTIAL
  PAID
}


